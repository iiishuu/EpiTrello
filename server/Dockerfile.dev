FROM node:20-alpine

WORKDIR /app

# Copy package files and prisma schema
COPY package*.json ./
COPY prisma ./prisma/

# Copy the entire project including node_modules
COPY . .

# Install dependencies if node_modules is missing or incomplete
RUN if [ ! -d "node_modules" ] || [ -z "$(ls -A node_modules 2>/dev/null)" ]; then \
      npm config set registry https://registry.npmjs.org/ && \
      npm config set fetch-retries 3 && \
      npm config set fetch-retry-mintimeout 10000 && \
      npm config set fetch-retry-maxtimeout 60000 && \
      npm install --legacy-peer-deps --no-audit --no-fund; \
    fi

# Generate Prisma client
RUN npx prisma generate

EXPOSE 5000

CMD ["npm", "run", "dev"]
